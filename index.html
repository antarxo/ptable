<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8">
  <title>Περιοδικός Πίνακας - Τελικός Κώδικας</title>
  <link href="https://fonts.googleapis.com/css?family=Roboto&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
  <style>
    body { 
      font-family: 'Roboto', sans-serif; 
      margin: 0; 
      overflow: hidden; 
      background: #f7f7f7; 
    }
    .canvas { 
      position: absolute; 
      background: transparent; 
      transition: all 0.5s ease-in-out; 
    }
    canvas {
      padding: 8px;
      filter: drop-shadow(4px 4px 4px rgba(0,0,0,0.5));
      overflow: visible;
    }
    /* Background canvas που καλύπτει το γεμισμένο τμήμα με margin 20px */
    #canvasTableBackground {
      position: absolute; 
      background: white; 
      border: 1px solid rgba(0,0,0,0.1);
      box-shadow: 6px 6px 10px rgba(0,0,0,0.3); 
      z-index: -10;
      transition: all 0.5s ease-in-out;
    }
    /* Ομαδοποίηση καμβάδων ομάδων – αρχικά κρυφοί */
    #canvasS_groups, #canvasD_groups, #canvasP_groups { 
      position: absolute;
      z-index: 60;
      display: none;
    }
    /* Καμβάδες τομέων και περιοδών */
    #canvasS { z-index: 10; }
    #canvasF { z-index: 20; }
    #canvasD { z-index: 30; }
    #canvasP { z-index: 40; }
    #canvasPeriods { z-index: 50; display: none; }
    /* Στυλ κουμπιών */
    #buttonPanel {
      position: fixed; 
      bottom: 20px; 
      right: 20px; 
      z-index: 100;
      display: flex; 
      flex-direction: column;
      gap: 5px;
    }
    #buttonPanel button {
      background-color: #008CBA; 
      color: white; 
      padding: 10px 15px;
      border: none; 
      border-radius: 5px; 
      cursor: pointer;
      box-shadow: 4px 4px 4px rgba(0,0,0,0.5);
    }
  </style>
</head>
<body>

  <!-- Καμβάδες -->
  <div id="canvasTableBackground"></div>
  <div id="canvasS_groups" class="canvas"></div>
  <div id="canvasD_groups" class="canvas"></div>
  <div id="canvasP_groups" class="canvas"></div>
  
  <div id="canvasPeriods" class="canvas"></div>
  <div id="canvasS" class="canvas"></div>
  <div id="canvasD" class="canvas"></div>
  <div id="canvasP" class="canvas"></div>
  <div id="canvasF" class="canvas"></div>

  <!-- Κουμπιά: Επόμενο, Συμπλήρωσε, Σύμπτυξε/Ανάπτυξε, Reset -->
  <div id="buttonPanel">
    <button id="nextState" disabled>Επόμενο</button>
    <button id="fillAll">Συμπλήρωσε</button>
    <button id="toggleFBlock" disabled>Σύμπτυξε</button>
    <button id="reset">Reset</button>
  </div>

  <script>
    // Τα δεδομένα φορτώνονται από τα JSON (elements.json και positions.json)
    let elements = [];
    let positions = {};
    let isTableFilled = false;
    // Η διάταξη για το "Επόμενο" είναι πάντα "start"
    let currentMode = "start";
    /* 
       currentZ χειρίζεται την προοδευτική εμφάνιση:
       - Πριν το πρώτο "Επόμενο" (currentZ = 2) δεν εμφανίζεται τίποτα.
       - Με το πρώτο πάτημα του "Επόμενο" τίθεται currentZ = 3 και ξεκινά η εμφάνιση (τα προηγούμενα παραμένουν στην οθόνη).
       - Οι μετατοπίσεις εφαρμόζονται πάνω στη διάταξη "start".
       - Από 21 έως 30 ο τομέας p μετατοπίζεται κατά 42px ανά βήμα,
         από 57 έως 70 μετατοπίζονται οι τομείς p και d.
       - Μετά το 118, διαδοχικά εμφανίζεται το στοιχείο 1 (currentZ = 119), το στοιχείο 2 (currentZ = 120),
         και στη συνέχεια οι περίοδοι (currentZ = 121) και οι ομάδες (currentZ = 122).
    */
    let currentZ = 2;

    // Εφαρμογή μετατοπίσεων στους τομείς p (και d όταν απαιτείται) βάσει του currentZ
    function updateSectors() {
      let shiftP = 0, shiftD = 0;
      if (currentZ <= 20) {
        shiftP = 0;
        shiftD = 0;
      } else if (currentZ >= 21 && currentZ <= 30) {
        shiftP = 42 * (currentZ - 20);
      } else if (currentZ >= 31 && currentZ <= 56) {
        shiftP = 42 * 10;
      } else if (currentZ >= 57 && currentZ <= 70) {
        shiftP = 42 * 10 + 42 * (currentZ - 56);
        shiftD = 42 * (currentZ - 56);
      } else if (currentZ > 70) {
        shiftP = 42 * 10 + 42 * 14;
        shiftD = 42 * 14;
      }
      let cP = document.getElementById('canvasP');
      if(cP) {
        cP.style.transition = "left 1.2s ease";
        cP.style.left = (159 + shiftP) + "px";
      }
      let cD = document.getElementById('canvasD');
      if(cD) {
        cD.style.transition = "left 1.2s ease";
        cD.style.left = (159 + shiftD) + "px";
      }
    }

    // Ενημέρωση εμφάνισης με το "Επόμενο" (μόνο στη διάταξη "start")
    function updateTable() {
      if (currentZ < 3) {
        // Το πρώτο πάτημα θέτει το currentZ στο 3
        currentZ = 3;
      } else if (currentZ < 118) {
        currentZ++;
      } else if (currentZ === 118) {
        currentZ = 119;  // Εμφάνιση στοιχείου 1
      } else if (currentZ === 119) {
        currentZ = 120;  // Εμφάνιση στοιχείου 2
      } else if (currentZ === 120) {
        currentZ = 121;  // Εμφάνιση περιόδων
        document.getElementById('canvasPeriods').style.display = 'block';
      } else if (currentZ === 121) {
        currentZ = 122;  // Εμφάνιση ομάδων
        document.getElementById('canvasS_groups').style.display = 'block';
        document.getElementById('canvasD_groups').style.display = 'block';
        document.getElementById('canvasP_groups').style.display = 'block';
      }
      // Διασφαλίζουμε ότι η διάταξη είναι πάντα "start" για το "Επόμενο"
      currentMode = "start";
      initializeBackgroundCanvas();
      initializeSectorsCanvas();
      updateSectors();
      console.log('CurrentZ:', currentZ);
      // Το κουμπί "Σύμπτυξε" απελευθερώνεται μόλις ολοκληρωθεί η διαδικασία (currentZ > 122)
      if (currentZ > 122) {
        document.getElementById('toggleFBlock').disabled = false;
      }
    }

    // Υπολογισμός δεξιού ορίου με margin 20px για το block (χρησιμοποιείται για το background)
    function computeRightLimit(block) {
      let maxX = -Infinity;
      elements.filter(e => e.block === block).forEach(e => {
        let pos = positions[currentMode][e.number];
        if (pos) {
          maxX = Math.max(maxX, pos.x + pos.width);
        }
      });
      return maxX + 20;
    }

    // Υπολογισμός κάτω ορίου με margin 20px για το block
    function computeBottomLimit(block) {
      let maxY = -Infinity;
      elements.filter(e => e.block === block).forEach(e => {
        let pos = positions[currentMode][e.number];
        if (pos) {
          maxY = Math.max(maxY, pos.y + pos.height);
        }
      });
      return maxY + 20;
    }

    // Ενημέρωση του background ώστε να καλύπτει το συμπληρωμένο τμήμα (με margin 20px)
    function initializeBackgroundCanvas() {
      let bg = document.getElementById("canvasTableBackground");
      let leftFixed = 17;
      let topFixed = 55;
      let rightLimit = computeRightLimit("p");
      let bottomLimit = computeBottomLimit("f");
      bg.style.left = leftFixed + "px";
      bg.style.top = topFixed + "px";
      bg.style.width = (rightLimit - leftFixed) + "px";
      bg.style.height = (bottomLimit - topFixed) + "px";
    }

    // Φόρτωση δεδομένων από τα JSON (elements.json και positions.json)
    async function loadData() {
      elements = await (await fetch('elements.json')).json();
      positions = await (await fetch('positions.json')).json();
    }

    // Δημιουργία καμβάδων περιόδων
    function initializePeriodsCanvas() {
      new p5(function(p) {
        p.setup = function() {
          let canvas = p.createCanvas(40, 292);
          canvas.parent("canvasPeriods");
          let container = document.getElementById("canvasPeriods");
          let bgLeft = parseInt(document.getElementById("canvasTableBackground").style.left);
          container.style.left = (bgLeft + 6) + "px";
          container.style.top = positions[currentMode]["1"].y + "px";
          p.noStroke();
          p.textAlign(p.CENTER, p.CENTER);
          p.textSize(11);
          p.textStyle(p.BOLD);
          const periodLabels = ["1η K", "2η L", "3η M", "4η N", "5η Ο", "6η Ρ", "7η Q"];
          for (let i = 0; i < 7; i++) {
            p.fill(240);
            p.rect(0, i * 42, 40, 40);
            p.fill(0);
            p.text(periodLabels[i], 20, i * 42 + 20);
          }
        };
      });
    }

    // Δημιουργία καμβάδων ομάδων (S, D, P)
    function initGroupsCanvases() {
      new p5(function(p) {
        p.setup = function() {
          let canvas = p.createCanvas(82, 40);
          canvas.parent("canvasS_groups");
          p.background(240);
          for (let col = 0; col < 2; col++) {
            p.noStroke();
            p.noFill();
            p.rect(col * 42, 0, 40, 20);
            p.rect(col * 42, 20, 40, 20);
          }
          p.noStroke();
          p.fill(0);
          p.textAlign(p.CENTER, p.CENTER);
          p.textSize(11);
          p.textStyle(p.BOLD);
          p.text("1", 20, 10);
          p.text("2", 20 + 42, 10);
          p.text("IA", 20, 30);
          p.text("IIA", 20 + 42, 30);
        };
      });
      
      new p5(function(p) {
        p.setup = function() {
          let canvas = p.createCanvas(418, 40);
          canvas.parent("canvasD_groups");
          p.background(240);
          for (let col = 0; col < 10; col++) {
            p.noStroke();
            p.noFill();
            p.rect(col * 42, 0, 40, 20);
            p.rect(col * 42, 20, 40, 20);
          }
          p.noStroke();
          p.fill(0);
          p.textAlign(p.CENTER, p.CENTER);
          p.textSize(11);
          p.textStyle(p.BOLD);
          for (let c = 0; c < 10; c++) {
            let x = c * 42;
            p.text((c+3).toString(), x + 20, 10);
          }
          const oldLabels = ["IIIB","IVB","VB","VIB","VIIB","VIIIB","VIIIB","VIIIB","IB","IIB"];
          for (let c = 0; c < 10; c++) {
            let x = c * 42;
            p.text(oldLabels[c], x + 20, 30);
          }
        };
      });
      
      new p5(function(p) {
        p.setup = function() {
          let canvas = p.createCanvas(250, 40);
          canvas.parent("canvasP_groups");
          p.background(240);
          for (let col = 0; col < 6; col++) {
            p.noStroke();
            p.noFill();
            p.rect(col * 42, 0, 40, 20);
            p.rect(col * 42, 20, 40, 20);
          }
          p.noStroke();
          p.fill(0);
          p.textAlign(p.CENTER, p.CENTER);
          p.textSize(11);
          p.textStyle(p.BOLD);
          for (let c = 0; c < 6; c++) {
            let x = c * 42;
            p.text((c+13).toString(), x + 20, 10);
          }
          const oldLabels = ["IIIA","IVA","VA","VIA","VIIA","VIIIA"];
          for (let c = 0; c < 6; c++) {
            let x = c * 42;
            p.text(oldLabels[c], x + 20, 30);
          }
        };
      });
      
      ["S", "D", "P"].forEach(sector => {
        let sectorCanvas = document.getElementById("canvas" + sector);
        let groupCanvas = document.getElementById("canvas" + sector + "_groups");
        if(sectorCanvas && groupCanvas) {
          groupCanvas.style.left = sectorCanvas.style.left;
          groupCanvas.style.top = (parseInt(positions[currentMode]["1"].y) - 42 - 2) + "px";
        }
      });
    }

    // Δημιουργία καμβάδων τομέων βάσει του JSON και της διάταξης "start"
    function initializeSectorsCanvas() {
      let blocks = ["s", "p", "d", "f"];
      blocks.forEach(block => {
        let container = document.getElementById("canvas" + block.toUpperCase());
        container.innerHTML = "";
        let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
        elements.filter(e => e.block === block).forEach(e => {
          let pos = positions[currentMode][e.number];
          if (pos) {
            minX = Math.min(minX, pos.x);
            minY = Math.min(minY, pos.y);
            maxX = Math.max(maxX, pos.x + pos.width);
            maxY = Math.max(maxY, pos.y + pos.height);
          }
        });
        if (minX === Infinity || minY === Infinity) return;
        container.style.left = minX + "px";
        container.style.top = minY + "px";
        container.style.width = (maxX - minX) + "px";
        container.style.height = (maxY - minY) + "px";
        new p5(function(p) {
          p.setup = function() {
            let canvas = p.createCanvas(parseInt(container.style.width), parseInt(container.style.height));
            canvas.parent("canvas" + block.toUpperCase());
            drawElements(p, block, minX, minY);
          };
        });
      });
    }

    // Σχεδίαση στοιχείων βάσει του JSON, φιλτράροντάς τα ανάλογα με το currentZ.
    function drawElements(p, block, containerLeft, containerTop) {
      let colors = { s: "#FF477E", p: "#26FF31", d: "#3F99FF", f: "#FFD051" };
      elements.filter(e => {
        let num = Number(e.number);
        if (currentZ < 119) {
          return num >= 3 && num <= currentZ;
        } else if (currentZ === 119) {
          return (num >= 3 && num <= 118) || num === 1;
        } else if (currentZ === 120) {
          return (num >= 3 && num <= 118) || num === 1 || num === 2;
        } else {
          return (num >= 3 && num <= 118) || num === 1 || num === 2;
        }
      }).forEach(e => {
        let pos = positions[currentMode][e.number];
        if (pos) {
          let relativeX = pos.x - containerLeft;
          let relativeY = pos.y - containerTop;
          p.fill(colors[block] || "#CCCCCC");
          p.rect(relativeX, relativeY, pos.width, pos.height, 5);
          p.fill(0);
          p.textSize(13);
          p.textStyle(p.BOLD);
          p.text(e.number, relativeX + pos.width/2, relativeY + pos.height/2);
        }
      });
    }

    // Το πλήκτρο "Συμπλήρωσε" παραμένει αμετάβλητο (copy-paste από το αρχικό FillAllToggle) και όταν πατηθεί θέτει το currentZ = 123,
    // ολοκληρώνοντας τη διαδικασία και απελευθερώνοντας τη χρήση του κουμπιού "Σύμπτυξε"/"Ανάπτυξε".
    document.getElementById('fillAll').addEventListener('click', function() {
      if (!isTableFilled) {
        initializeBackgroundCanvas();
        initializeSectorsCanvas();
        initializePeriodsCanvas();
        initGroupsCanvases();
        isTableFilled = true;
        currentZ = 123;
        document.getElementById('toggleFBlock').disabled = false;
        document.getElementById('nextState').disabled = false;
      }
    });

    // Το πλήκτρο "Επόμενο" λειτουργεί αποκλειστικά στη διάταξη "start"
    document.getElementById('nextState').addEventListener('click', function() {
      updateTable();
    });

    // Το πλήκτρο "Σύμπτυξε/Ανάπτυξε" παραμένει ανενεργό μέχρι το currentZ > 122 ή να πατηθεί το "Συμπλήρωσε"
    document.getElementById('toggleFBlock').addEventListener('click', function() {
      if (currentZ <= 122) return;
      isCollapsed = !isCollapsed;
      this.textContent = isCollapsed ? "Ανάπτυξε" : "Σύμπτυξε";
      currentMode = isCollapsed ? "collapsed" : "expanded";
      initializeBackgroundCanvas();
      initializeSectorsCanvas();
      ["S", "D", "P"].forEach(sector => {
        let sectorCanvas = document.getElementById("canvas" + sector);
        let groupCanvas = document.getElementById("canvas" + sector + "_groups");
        if(sectorCanvas && groupCanvas) {
          groupCanvas.style.left = sectorCanvas.style.left;
          groupCanvas.style.top = (parseInt(positions[currentMode]["1"].y) - 42 - 2) + "px";
        }
      });
    });

    document.getElementById('reset').addEventListener('click', function() {
      location.reload();
    });

    window.addEventListener('load', loadData);
  </script>
</body>
</html>
