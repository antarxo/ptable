<script>
  // Νέα λογική τοποθέτησης του Balloon:
  function updateBalloonPosition(element) {
    // Λήψη θέσης του κελιού με βάση το block του στοιχείου:
    let block = element.block;
    let pos = calculatePosition(element, block); // Η υπάρχουσα συνάρτηση
    let canvasElem = document.getElementById("canvas" + block.toUpperCase());
    if (!canvasElem) return;
    let cellRect = canvasElem.getBoundingClientRect();
    // Υποθέτουμε ότι το κελί έχει διαστάσεις 40x40:
    let cellX = cellRect.left + pos.x;
    let cellY = cellRect.top + pos.y;
    let cellRight = cellX + 40;
    let cellBottom = cellY + 40;
    // Default θέση: η πάνω αριστερή γωνία του balloon στην κάτω δεξιά γωνία του κελιού.
    let desiredLeft = cellRight;
    let desiredTop = cellBottom;
    
    let balloon = document.getElementById("canvasSubshells");
    let balloonRect = balloon.getBoundingClientRect();
    
    // Έλεγχος οριζόντιων ορίων: αν desiredLeft + balloon.width > 1250,
    // μετατοπίζουμε το balloon αριστερά κατά (balloon.width + 42px).
    if (desiredLeft + balloonRect.width > 1250) {
       desiredLeft = desiredLeft - (balloonRect.width + 42);
    }
    
    // Έλεγχος κάθετων ορίων: αν desiredTop + balloon.height υπερβαίνει το πάνω όριο του infoPanel,
    // μετατοπίζουμε το balloon προς τα πάνω κατά (balloon.height + 42px).
    let infoPanel = document.getElementById("infoPanel");
    if (infoPanel && (desiredTop + balloonRect.height > infoPanel.getBoundingClientRect().top)) {
       desiredTop = desiredTop - (balloonRect.height + 42);
    }
    
    // Τελική προσαρμογή: clamp ώστε οι τιμές να είναι τουλάχιστον 0.
    let newLeft = Math.max(desiredLeft, 0);
    let newTop = Math.max(desiredTop, 0);
    
    balloon.style.left = newLeft + "px";
    balloon.style.top = newTop + "px";
    balloon.style.display = "block";
  }
  
  // Νέα λογική εμφάνισης του InfoPanel:
  // Τα στοιχεία που χρειάζονται για τις υποστιβάδες προέρχονται από το προηγούμενο και επόμενο στοιχείο.
  function updateInfoPanel(element, prevElement, nextElement) {
    // Αριστερή στήλη: Εμφάνιση του στοιχείου με το Z, το σύμβολο και το όνομα.
    let displayZ = (element.number >= 119) ? (element.number - 118) : element.number;
    let leftColumnHTML = `<span style="font-size:1.3em; font-weight:bold; color:black;">Ζ=${displayZ}</span> ` +
                           `<span style="font-size:3em; font-weight:bold; color:${getBlockColor(element.block)};">${element.symbol}</span> ` +
                           `<span style="font-style: italic;">${element.name}</span>`;
    
    // Δεξί κελί: Άνω σειρά – δύο στήλες ίσου πλάτους.
    // Στην αριστερή στήλη εμφανίζονται οι υποστιβάδες (προηγούμενη, τρέχουσα, επόμενη).
    let subshellsHTML = `<div style="width:50%; text-align:left;">` +
                         `<div>${prevElement ? prevElement.subshells : ''}</div>` +
                         `<div>${element.subshells}</div>` +
                         `<div>${nextElement ? nextElement.subshells : ''}</div>` +
                         `</div>`;
    
    // Στη δεξιά στήλη εμφανίζονται οι στιβάδες σε μορφή "K(2), L(8), M(3)".
    let shellsHTML = `<div style="width:50%; text-align:left;">` +
                     `<strong>Στιβάδες:</strong> ${formatShells(element.shells || '')}` +
                     `</div>`;
    
    let upperRowHTML = `<div style="display:flex;">${subshellsHTML}${shellsHTML}</div>`;
    
    // Μήνυμα που υπολογίζεται βάσει του στοιχείου:
    let message = "";
    if (element.block === 'f') {
      // Αν το στοιχείο ανήκει στον f τομέα, για παράδειγμα μπορούμε να εμφανίζουμε "Λανθανίδα"
      // (ή "Ακτινίδα" για τα στοιχεία της σειράς των ακτινιδών, ανάλογα με το στοιχείο).
      message = "Λανθανίδα"; 
    } else {
      let group = parseInt(element.group);
      let outer = parseInt(element.outerShell) || 0;
      if (group === 1 || group === 2 || group === 13) {
        message = `Θέλει να δώσει ${outer} ηλεκτρόνια`;
      } else if (group >= 3 && group <= 12) {
        message = "Στοιχείο μετάπτωσης";
      } else if (group === 14) {
        message = "Θέλει να δώσει ή να πάρει 4 ηλεκτρόνια";
      } else if (group >= 15 && group <= 17) {
        message = `Θέλει να πάρει ${8 - outer} ηλεκτρόνια`;
      } else if (group === 18) {
        message = "Ευγενές αέριο-Χημικά αδρανές";
      }
    }
    let messageRowHTML = `<div style="margin-top:10px; text-align:left;">${message}</div>`;
    
    // Κάτω σειρά: Εμφάνιση των remarks (με κεντρική στοίχιση).
    let lowerRowHTML = `<div style="text-align:center; margin-top:10px;">${element.remarks || ''}</div>`;
    
    // Ενημέρωση του InfoPanel: (στο αρχικό layout, η αριστερή στήλη εμφανίζεται στο στοιχείο με id "elementInfo"
    // και το δεξί κελί στο στοιχείο με id "remarks").
    document.getElementById('elementInfo').innerHTML = leftColumnHTML;
    document.getElementById('remarks').innerHTML = upperRowHTML + messageRowHTML + lowerRowHTML;
  }
</script>
