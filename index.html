<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8">
  <title>Περιοδικός Πίνακας - FillTogginfo</title>
  <link href="https://fonts.googleapis.com/css?family=Roboto&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      overflow: hidden;
      background: #f7f7f7;
    }
    .canvas {
      position: absolute;
      background: transparent;
    }
    #canvasTableBackground {
      position: absolute;
      background: white;
      border: 1px solid rgba(0,0,0,0.1);
      box-shadow: 0 3px 3px rgba(0,0,0,0.2);
      z-index: -10;
      opacity: 1;
    }
    #infoPanelFull, #infoPanelCollapsed {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: #fff;
      border: 2px solid #333;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 3px 3px rgba(0,0,0,0.3);
      z-index: 50;
      transition: all 0.5s ease;
    }
    #infoPanelCollapsed {
      display: none;
    }
    #buttonPanel {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: flex;
      gap: 5px;
      z-index: 150;
    }
  </style>
</head>
<body>

  <div id="canvasTableBackground"></div>
  <div id="canvasS_groups" class="canvas"></div>
  <div id="canvasD_groups" class="canvas"></div>
  <div id="canvasP_groups" class="canvas"></div>
  <div id="canvasPeriods" class="canvas"></div>
  <div id="canvasS" class="canvas"></div>
  <div id="canvasD" class="canvas"></div>
  <div id="canvasP" class="canvas"></div>
  <div id="canvasF" class="canvas"></div>
  <div id="canvasSubshells" class="canvas"></div>

  <!-- Info Panels -->
  <div id="infoPanelFull"></div>
  <div id="infoPanelCollapsed"></div>

  <!-- Button Panel -->
  <div id="buttonPanel">
    <button id="nextElement">Επόμενο</button>
    <button id="fillAll">Συμπλήρωσε</button>
    <button id="toggleFBlock" disabled>Σύμπτυξε</button>
    <button id="reset">Reset</button>
  </div>

  <script>
  let elements = [];
  let positions = {};
  let blockOffsets = {};
  let isTableFilled = false;
  let isCollapsed = false;
  let currentMode = "start";

  const expandedBackground = { width: "1412px", height: "368px" };
  const collapsedBackground  = { width: "837px",  height: "460px" };

  let spatialHashMaps = {};
  
  function buildSpatialHash(mode) {
    let spatialHash = {};
    const cellSize = 40;
    let minX = Infinity, minY = Infinity;
    for (let atomicNumber in positions[mode]) {
      let rect = positions[mode][atomicNumber];
      if (rect.x < minX) minX = rect.x;
      if (rect.y < minY) minY = rect.y;
    }
    for (let atomicNumber in positions[mode]) {
      let rect = positions[mode][atomicNumber];
      let col = Math.floor((rect.x - minX) / cellSize);
      let row = Math.floor((rect.y - minY) / cellSize);
      let key = col + "_" + row;
      if (!spatialHash[key]) spatialHash[key] = [];
      spatialHash[key].push({ atomicNumber: atomicNumber, rect: rect });
    }
    spatialHash.offsetX = minX;
    spatialHash.offsetY = minY;
    spatialHash.cellSize = cellSize;
    return spatialHash;
  }

  function buildAllSpatialHashes() {
    if (positions.collapsed) spatialHashMaps["collapsed"] = buildSpatialHash("collapsed");
    if (positions.expanded) spatialHashMaps["expanded"] = buildSpatialHash("expanded");
    if (positions.start) spatialHashMaps["start"] = buildSpatialHash("start");
  }

  function handleMouseClick(event) {
    let clickX = event.clientX;
    let clickY = event.clientY;
    let hashMap = spatialHashMaps[currentMode];
    if (!hashMap) return;
    let atomicNumber = getElementFromClick(clickX, clickY, hashMap);
    if (!atomicNumber) return;
    let element = elements.find(e => e.number == atomicNumber);
    if (!element) return;
    updateInfo(element);
  }

  function updateInfo(element) {
    if (!element) return;
    let panel = document.getElementById("infoPanelFull");
    if (!panel) return;
    panel.innerHTML = `<strong>Ζ=${element.number}</strong> <br> 
                      <span style="font-size:2em;">${element.symbol}</span> <br>
                      <em>${element.name}</em>`;
  }

  async function loadData() {
    elements = await (await fetch('elements.json')).json();
    positions = await (await fetch('positions.json')).json();
    buildAllSpatialHashes();
    if (!isTableFilled) document.getElementById('fillAll').click();
  }

  document.getElementById('fillAll').addEventListener('click', function() {
    isTableFilled = true;
    document.getElementById('toggleFBlock').disabled = false;
  });

  document.getElementById('toggleFBlock').addEventListener('click', function() {
    isCollapsed = !isCollapsed;
    this.textContent = isCollapsed ? "Ανάπτυξε" : "Σύμπτυξε";
    currentMode = isCollapsed ? "collapsed" : "expanded";
  });

  document.getElementById('nextElement').addEventListener('click', function() {
    console.log("Το κουμπί 'Επόμενο' πατήθηκε.");
  });

  document.getElementById('reset').addEventListener('click', function() {
    location.reload();
  });

  document.addEventListener('click', handleMouseClick);
  window.addEventListener('load', loadData);
  </script>
</body>
</html>
