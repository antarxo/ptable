<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8">
  <title>Περιοδικός Πίνακας - Debug Grid με Μετρήσεις</title>
  <link href="https://fonts.googleapis.com/css?family=Roboto&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
  <style>
    body { 
      font-family: 'Roboto', sans-serif; 
      margin: 0; 
      overflow: hidden; 
      background: #f7f7f7; 
    }
    .canvas { 
      position: absolute; 
      background: transparent; 
      transition: all 0.5s ease-in-out; 
    }
    canvas {
      padding: 8px;
      filter: drop-shadow(4px 4px 4px rgba(0,0,0,0.5));
      overflow: visible;
    }
    #canvasTableBackground {
      position: absolute; 
      background: white; 
      border: 1px solid rgba(0,0,0,0.1);
      box-shadow: 0 3px 3px rgba(0,0,0,0.2); 
      z-index: -10;
      opacity: 1;
    }
    /* Debug grid overlay – εμφανίζεται πάνω από το background και είναι draggable */
    #debugGrid {
      position: absolute;
      z-index: -5;
      pointer-events: auto;
      cursor: move;
    }
    #canvasS_groups, #canvasD_groups, #canvasP_groups { 
      position: absolute; 
      height: 40px; 
    }
    #canvasPeriods, #canvasS, #canvasD, #canvasP, #canvasF {
      position: absolute;
    }
    #canvasS { z-index: 10; }
    #canvasF { z-index: 20; }
    #canvasD { z-index: 30; }
    #canvasP { z-index: 40; }
    #buttonPanel {
      position: fixed; bottom: 20px; right: 20px; z-index: 100;
      display: flex; gap: 5px;
    }
    #buttonPanel button {
      background-color: #008CBA; 
      color: white; 
      padding: 10px 15px;
      border: none; 
      border-radius: 5px; 
      cursor: pointer;
    }
  </style>
</head>
<body>

  <!-- Καμβάδες -->
  <div id="canvasTableBackground"></div>
  <!-- Debug grid overlay -->
  <div id="debugGrid" class="canvas"></div>
  <div id="canvasS_groups" class="canvas"></div>
  <div id="canvasD_groups" class="canvas"></div>
  <div id="canvasP_groups" class="canvas"></div>
  
  <div id="canvasPeriods" class="canvas"></div>
  <div id="canvasS" class="canvas"></div>
  <div id="canvasD" class="canvas"></div>
  <div id="canvasP" class="canvas"></div>
  <div id="canvasF" class="canvas"></div>

  <!-- Κουμπιά -->
  <div id="buttonPanel">
    <button id="fillAll">Συμπλήρωσε</button>
    <button id="toggleFBlock" disabled>Σύμπτυξε</button>
  </div>

  <script>
    let elements = [];
    let positions = {};
    let isTableFilled = false;
    let isCollapsed = false;
    let currentMode = "expanded";  // "expanded" ή "collapsed"
    let debugGridP = null; // p5 instance για το debug grid

    // Διαστάσεις του background ανά mode
    const expandedBackground = { width: "1412px", height: "368px" };
    const collapsedBackground  = { width: "837px",  height: "460px" };

    function checkJSON(json) {
      if (!json.expanded || !json.collapsed) {
        console.error("Το positions.json δεν έχει την απαιτούμενη δομή (πρέπει να περιέχει τα keys 'expanded' και 'collapsed').");
      } else {
        console.log("Το positions.json ελέγχθηκε: Βασικά keys υπάρχουν.");
      }
    }

    async function loadData() {
      elements = await (await fetch('elements.json')).json();
      positions = await (await fetch('positions.json')).json();
      checkJSON(positions);
    }

    function initializeBackgroundCanvas() {
      let bg = document.getElementById("canvasTableBackground");
      bg.style.left = "17px";
      bg.style.top = "55px";
      bg.style.width = expandedBackground.width;
      bg.style.height = expandedBackground.height;
      bg.style.opacity = "1";
    }

    function updateBackgroundDimensions() {
      let bg = document.getElementById("canvasTableBackground");
      if(currentMode === "collapsed") {
        bg.style.width = collapsedBackground.width;
        bg.style.height = collapsedBackground.height;
      } else {
        bg.style.width = expandedBackground.width;
        bg.style.height = expandedBackground.height;
      }
    }

    // Δημιουργεί το debug grid και εμφανίζει την τρέχουσα left/top τιμή (σε px) στο πάνω αριστερό μέρος.
    function initializeDebugGrid() {
      let debugDiv = document.getElementById("debugGrid");
      if(currentMode !== "expanded") {
        if(debugGridP) {
          debugGridP.remove();
          debugGridP = null;
        }
        return;
      }
      // Τοποθέτηση debug grid πάνω από το canvasTableBackground
      let bg = document.getElementById("canvasTableBackground");
      debugDiv.style.left = bg.style.left;
      debugDiv.style.top = bg.style.top;
      debugDiv.style.width = bg.style.width;
      debugDiv.style.height = bg.style.height;
      
      if(debugGridP) {
        debugGridP.remove();
        debugGridP = null;
      }
      debugGridP = new p5(function(p) {
          p.setup = function() {
            let w = parseInt(debugDiv.style.width);
            let h = parseInt(debugDiv.style.height);
            p.createCanvas(w, h);
          };
          p.draw = function() {
            p.clear();
            p.stroke(255, 0, 0, 150); // κόκκινες γραμμές
            let spacing = 20;
            for(let x = 0; x <= p.width; x += spacing) {
              p.line(x, 0, x, p.height);
            }
            for(let y = 0; y <= p.height; y += spacing) {
              p.line(0, y, p.width, y);
            }
            // Εμφάνιση του τρέχοντος offset (μετράει σε px)
            let debugDiv = document.getElementById("debugGrid");
            let left = parseInt(debugDiv.style.left);
            let top = parseInt(debugDiv.style.top);
            p.fill(0);
            p.noStroke();
            p.textSize(16);
            p.text(`left: ${left}px, top: ${top}px`, 10, 20);
          };
      }, "debugGrid");
      
      enableDragForDebugGrid();
    }

    // Επιτρέπει τη μετακίνηση (drag) του debug grid και ενημερώνει το position ώστε να βλέπεις τις αλλαγές σε px
    function enableDragForDebugGrid() {
      let debugDiv = document.getElementById("debugGrid");
      let isDragging = false;
      let offsetX, offsetY;
      
      debugDiv.addEventListener('mousedown', function(e) {
        isDragging = true;
        offsetX = e.clientX - parseInt(debugDiv.style.left);
        offsetY = e.clientY - parseInt(debugDiv.style.top);
        e.preventDefault();
      });
      
      document.addEventListener('mousemove', function(e) {
        if(isDragging) {
          debugDiv.style.left = (e.clientX - offsetX) + "px";
          debugDiv.style.top = (e.clientY - offsetY) + "px";
        }
      });
      
      document.addEventListener('mouseup', function(e) {
        isDragging = false;
      });
    }

    function initGroupsCanvases() {
      if(window.groupsInitialized) return;
      
      new p5(function(p) {
        p.setup = function() {
          let canvas = p.createCanvas(84, 40);
          canvas.parent("canvasS_groups");
          p.noStroke();
          p.textAlign(p.CENTER, p.CENTER);
          p.textSize(11);
          p.textStyle(p.BOLD);
          p.background(240);
          p.text("1", 20, 10);
          p.text("2", 62, 10);
          p.text("IA", 20, 30);
          p.text("IIA", 62, 30);
        };
      });
      
      new p5(function(p) {
        p.setup = function() {
          let canvas = p.createCanvas(420, 40);
          canvas.parent("canvasD_groups");
          p.noStroke();
          p.textAlign(p.CENTER, p.CENTER);
          p.textSize(11);
          p.textStyle(p.BOLD);
          p.background(240);
          for(let c = 0; c < 10; c++){
            let x = c * 42;
            p.text((c+3).toString(), x + 20, 10);
          }
          const oldLabels = ["IIIB","IVB","VB","VIB","VIIB","VIIIB","VIIIB","VIIIB","IB","IIB"];
          for(let c = 0; c < 10; c++){
            let x = c * 42;
            p.text(oldLabels[c], x + 20, 30);
          }
        };
      });
      
      new p5(function(p) {
        p.setup = function() {
          let canvas = p.createCanvas(252, 40);
          canvas.parent("canvasP_groups");
          p.noStroke();
          p.textAlign(p.CENTER, p.CENTER);
          p.textSize(11);
          p.textStyle(p.BOLD);
          p.background(240);
          for(let c = 0; c < 6; c++){
            let x = c * 42;
            p.text((c+13).toString(), x + 20, 10);
          }
          const oldLabels = ["IIIA","IVA","VA","VIA","VIIA","VIIIA"];
          for(let c = 0; c < 6; c++){
            let x = c * 42;
            p.text(oldLabels[c], x + 20, 30);
          }
        };
      });
      
      ["S", "D", "P"].forEach(sector => {
        let sectorCanvas = document.getElementById("canvas" + sector);
        let groupCanvas = document.getElementById("canvas" + sector + "_groups");
        if(sectorCanvas && groupCanvas) {
          groupCanvas.style.left = sectorCanvas.style.left;
          if(positions[currentMode]["1"]) {
            groupCanvas.style.top = (positions[currentMode]["1"].y + 2) + "px";
          }
        }
      });
      
      window.groupsInitialized = true;
    }

    function initializePeriodsCanvas() {
      new p5(function(p) {
        p.setup = function() {
          let canvas = p.createCanvas(40, 294);
          canvas.parent("canvasPeriods");
          let container = document.getElementById("canvasPeriods");
          let bgLeft = parseInt(document.getElementById("canvasTableBackground").style.left);
          container.style.left = (bgLeft + 6) + "px";
          container.style.top = "110px";
          p.noStroke();
          p.textAlign(p.CENTER, p.CENTER);
          p.textSize(11);
          p.textStyle(p.BOLD);
          const periodLabels = ["1η K", "2η L", "3η M", "4η N", "5η Ο", "6η Ρ", "7η Q"];
          for (let i = 0; i < 7; i++) {
            p.fill(240);
            p.rect(5, i * 42, 35, 40);
            p.fill(0);
            p.text(periodLabels[i], 5 + 35/2, i * 42 + 20);
          }
        };
      });
    }

    // Χρήση των τιμών του JSON για τοποθέτηση των block χωρίς επιπλέον offsets
    function initializeSectorsCanvas() {
      let blocks = ["s", "p", "d", "f"];
      blocks.forEach(block => {
        let container = document.getElementById("canvas" + block.toUpperCase());
        container.innerHTML = "";
        let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
        elements.filter(e => e.block === block).forEach(e => {
          if(positions[currentMode][e.number]){
            let pos = positions[currentMode][e.number];
            minX = Math.min(minX, pos.x);
            minY = Math.min(minY, pos.y);
            maxX = Math.max(maxX, pos.x + pos.width);
            maxY = Math.max(maxY, pos.y + pos.height);
          }
        });
        if(minX === Infinity || minY === Infinity) return;
        container.style.left = minX + "px";
        container.style.top = minY + "px";
        container.style.width = (maxX - minX) + "px";
        container.style.height = (maxY - minY) + "px";
        
        let firstEl = elements.find(e => e.block === block);
        if(firstEl && positions[currentMode][firstEl.number]) {
          let expectedTop = positions[currentMode][firstEl.number].y;
          if(container.style.top !== expectedTop + "px") {
            console.warn(`Block ${block}: container.style.top (${container.style.top}) διαφέρει από την αναμενόμενη τιμή (${expectedTop}px)`);
          } else {
            console.log(`Block ${block}: container.style.top είναι όπως αναμένεται (${container.style.top})`);
          }
        }
        
        new p5(function(p) {
          p.setup = function() {
            let canvas = p.createCanvas(parseInt(container.style.width), parseInt(container.style.height));
            canvas.parent("canvas" + block.toUpperCase());
            drawElements(p, block, minX, minY);
          };
        });
      });
    }

    function drawElements(p, block, containerLeft, containerTop) {
      let colors = { s: "#FF477E", p: "#26FF31", d: "#3F99FF", f: "#FFD051" };
      elements.filter(e => e.block === block).forEach(e => {
        let pos = positions[currentMode][e.number];
        if(pos){
          let relativeX = pos.x - containerLeft;
          let relativeY = pos.y - containerTop;
          p.fill(colors[block] || "#CCCCCC");
          p.rect(relativeX, relativeY, pos.width, pos.height, 5);
          p.fill(0);
          p.textSize(13);
          p.textStyle(p.BOLD);
          p.textAlign(p.CENTER, p.CENTER);
          p.text(e.number, relativeX + pos.width/2, relativeY + pos.height/2);
        }
      });
    }

    document.getElementById('fillAll').addEventListener('click', function() {
      if (!isTableFilled) {
        initializeBackgroundCanvas();
        initializeSectorsCanvas();       
        initializePeriodsCanvas();       
        initGroupsCanvases();
        initializeDebugGrid();  // Εμφάνιση debug grid στην expanded διάταξη
        isTableFilled = true;
        document.getElementById('toggleFBlock').disabled = false;
      }
    });

    document.getElementById('toggleFBlock').addEventListener('click', function() {
      isCollapsed = !isCollapsed;
      this.textContent = isCollapsed ? "Ανάπτυξε" : "Σύμπτυξε";
      currentMode = isCollapsed ? "collapsed" : "expanded";
      updateBackgroundDimensions();
      initializeSectorsCanvas();
      ["S", "D", "P"].forEach(sector => {
        let sectorCanvas = document.getElementById("canvas" + sector);
        let groupCanvas = document.getElementById("canvas" + sector + "_groups");
        if(sectorCanvas && groupCanvas) {
          groupCanvas.style.left = sectorCanvas.style.left;
          if(positions[currentMode]["1"]) {
            groupCanvas.style.top = (positions[currentMode]["1"].y + 2) + "px";
          }
        }
      });
      initializeDebugGrid();
    });

    window.addEventListener('load', loadData);
  </script>

</body>
</html>
