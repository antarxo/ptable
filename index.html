<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8">
  <title>Περιοδικός Πίνακας - Τελική Τοποθέτηση</title>
  <link href="https://fonts.googleapis.com/css?family=Roboto&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
  <style>
    body { font-family: 'Roboto', sans-serif; margin: 0; overflow: hidden; background: #f7f7f7; }
    .canvas { position: absolute; background: transparent; transition: all 0.5s ease-in-out; }
    #canvasTableBackground {
      position: absolute; background: white; border: 1px solid rgba(0,0,0,0.1);
      box-shadow: 0 3px 3px rgba(0,0,0,0.2); z-index: -10;
      opacity: 1;
    }
    #buttonPanel {
      position: fixed; bottom: 20px; right: 20px; z-index: 100;
    }
    #buttonPanel button {
      background-color: #008CBA; color: white; padding: 10px 15px;
      border: none; border-radius: 5px; cursor: pointer;
    }
  </style>
</head>
<body>

  <!-- Καμβάδες -->
  <div id="canvasTableBackground"></div>
  <div id="canvasGroups" class="canvas"></div>
  <div id="canvasPeriods" class="canvas"></div>
  <!-- Τομείς: Εμφανίζονται όλοι: s, p, d, f, MONO -->
  <div id="canvasS" class="canvas"></div>
  <div id="canvasP" class="canvas"></div>
  <div id="canvasD" class="canvas"></div>
  <div id="canvasF" class="canvas"></div>
  <div id="canvasMONO" class="canvas"></div>

  <!-- Κουμπί για συμπλήρωση -->
  <div id="buttonPanel">
    <button id="fillAll">Συμπλήρωσε</button>
  </div>

  <script>
    let elements = [];
    let positions = {};
    let blockOffsets = {}; 
    let isTableFilled = false; // Εξασφαλίζει ότι τα canvases δημιουργούνται μία φορά

    async function loadData() {
      elements = await (await fetch('elements.json')).json();
      positions = await (await fetch('positions.json')).json();
      computeBlockOffsets();
      // Δεν δημιουργούμε καμία διεπαφή εδώ – όλα εμφανίζονται μετά το "Συμπλήρωσε"
    }

    // Υπολογισμός των ορίων για κάθε block (s, p, d, f, MONO)
    function computeBlockOffsets() {
      let blocks = ["s", "p", "d", "f", "MONO"];
      blocks.forEach(block => {
        let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
        Object.keys(positions.expanded).forEach(num => {
          let e = elements.find(el => el.number == num);
          if (e && e.block === block) {
            let pos = positions.expanded[num];
            minX = Math.min(minX, pos.x);
            minY = Math.min(minY, pos.y);
            maxX = Math.max(maxX, pos.x + pos.width);
            maxY = Math.max(maxY, pos.y + pos.height);
          }
        });
        blockOffsets[block] = { minX, minY, width: maxX - minX, height: maxY - minY };
      });
    }

    function calculateRelativePosition(element, block) {
      let pos = positions.expanded[element.number];
      let offset = blockOffsets[block];
      return { x: pos.x - offset.minX, y: pos.y - offset.minY };
    }

    // Δημιουργία του background canvas
    function initializeBackgroundCanvas() {
      let bg = document.getElementById("canvasTableBackground");
      bg.style.left = "20px"; // background left = 20px
      bg.style.top = "50px";  // background top = 50px
      bg.style.width = "1412px";
      bg.style.height = "368px";
      bg.style.opacity = "1";
    }

    // Δημιουργία του canvas των ομάδων
    function initializeGroupsCanvas() {
      new p5(function(p) {
        p.setup = function() {
          let canvas = p.createCanvas(1040, 40);
          canvas.parent("canvasGroups");
          let container = document.getElementById("canvasGroups");
          container.style.top = "70px"; // top = background top (50) + 20 = 70px
          container.style.left = positions.expanded["3"].x + "px";
          p.noStroke();
          p.textAlign(p.CENTER, p.CENTER);
          p.textSize(13);
          p.textStyle(p.BOLD);
          for (let i = 0; i < 18; i++) {
            let x = i * 58;
            p.fill(240);
            p.rect(x, 0, 40, 40);
            p.fill(0);
            p.text(i + 1, x + 20, 20);
          }
        };
      });
    }

    // Δημιουργία του canvas των περιόδων
    function initializePeriodsCanvas() {
      new p5(function(p) {
        p.setup = function() {
          let canvas = p.createCanvas(40, 294);
          canvas.parent("canvasPeriods");
          let container = document.getElementById("canvasPeriods");
          let bgLeft = parseInt(document.getElementById("canvasTableBackground").style.left); // 20
          container.style.left = (bgLeft + 10) + "px"; // 20+10 = 30px
          container.style.top = "110px"; // top = bottom των ομάδων (70+40 = 110px)
          p.noStroke();
          p.textAlign(p.CENTER, p.CENTER);
          p.textSize(13);
          p.textStyle(p.BOLD);
          const periodLabels = ["1", "2", "3", "4", "5", "6", "7"];
          for (let i = 0; i < 7; i++) {
            p.fill(240);
            // Σχεδιάζουμε τα ορθάγωνα με 5px από το αριστερό όριο του καμβά
            p.rect(5, i * 42, 35, 40);
            p.fill(0);
            p.text(periodLabels[i], 5 + 35/2, i * 42 + 20);
          }
        };
      });
    }

    // Δημιουργία των καμβάδων των τομέων
    function initializeSectorsCanvas() {
      let bgLeft = parseInt(document.getElementById("canvasTableBackground").style.left); // 20
      let targetLeft = bgLeft + 50; // 20+50 = 70px
      // Ορίζουμε δύο ομάδες:
      // Ομάδα Α: s, p, MONO -> top = bottom των ομάδων = 110px
      let blocksGroupA = ["s", "p", "MONO"];
      blocksGroupA.forEach(block => {
        let delta = (targetLeft - blockOffsets[block].minX);
        let container = document.getElementById("canvas" + block.toUpperCase());
        container.innerHTML = "";
        container.style.left = (blockOffsets[block].minX + delta) + "px"; // θα είναι 70px
        container.style.top = "110px"; // top = 110px
        container.style.width = blockOffsets[block].width + "px";
        container.style.height = blockOffsets[block].height + "px";
        new p5(function(p) {
          p.setup = function() {
            let canvas = p.createCanvas(blockOffsets[block].width, blockOffsets[block].height);
            canvas.parent("canvas" + block.toUpperCase());
            drawElements(p, block);
          };
        });
      });
      // Ομάδα Β: d, f -> ευθυγράμμιση του bottom με το bottom των τομέων s και p.
      let blocksGroupB = ["d", "f"];
      // Ορίζουμε το referenceBottom από το block s: bottom = 110 + height(s)
      let referenceBottom = 110 + blockOffsets["s"].height;
      blocksGroupB.forEach(block => {
        let delta = (targetLeft - blockOffsets[block].minX);
        let container = document.getElementById("canvas" + block.toUpperCase());
        container.innerHTML = "";
        container.style.left = (blockOffsets[block].minX + delta) + "px"; // 70px
        // Το top ορίζεται έτσι ώστε το κάτω μέρος (top + height) να ισούται με το referenceBottom
        container.style.top = (referenceBottom - blockOffsets[block].height) + "px";
        container.style.width = blockOffsets[block].width + "px";
        container.style.height = blockOffsets[block].height + "px";
        new p5(function(p) {
          p.setup = function() {
            let canvas = p.createCanvas(blockOffsets[block].width, blockOffsets[block].height);
            canvas.parent("canvas" + block.toUpperCase());
            drawElements(p, block);
          };
        });
      });
    }

    function drawElements(p, block) {
      elements.filter(e => e.block === block).forEach(e => {
        let pos = calculateRelativePosition(e, block);
        let colors = { s: "#FF477E", p: "#26FF31", d: "#3F99FF", f: "#FFD051", MONO: "#AA66CC" };
        p.fill(colors[block] || "#CCCCCC");
        p.rect(pos.x, pos.y, 40, 40, 5);
        p.fill(0);
        p.textSize(13);
        p.textStyle(p.BOLD);
        p.textAlign(p.CENTER, p.CENTER);
        p.text(e.number, pos.x + 20, pos.y + 20);
      });
    }

    // Το κουμπί "Συμπλήρωσε" δημιουργεί όλα τα canvases
    document.getElementById('fillAll').addEventListener('click', function() {
      if (!isTableFilled) {
        initializeBackgroundCanvas();
        initializeGroupsCanvas();
        initializePeriodsCanvas();
        initializeSectorsCanvas();
        isTableFilled = true;
      }
    });

    window.addEventListener('load', loadData);
  </script>

</body>
</html>
